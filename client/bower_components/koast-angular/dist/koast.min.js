!function(e,t,n){"use strict";angular.module("koast",["koast-user","koast-resource","koast-versionCheck"]).run(function(){if(typeof _==typeof n)throw new Error("_ is undefined. koast-angular requires underscore or lodash to be loaded")}),angular.module("koast").constant("peerDependencies",{koast:">=0.4.5"}),angular.module("koast").factory("koast",["_koastUser","_koastResourceGetter","$log","_koastHttp","versionCheck",function(e,t,n,r,o){var a={},u=["setApiUriPrefix","getResource","createResource","queryForResources","addEndpoint"];return a.user=e,u.forEach(function(e){a[e]=t[e]}),a.init=function(a){n.info("Initializing koast."),r.setOptions(a),e.init(a),t.init(a),o.isCompatible()},a}]),angular.module("koast-http",["koast-logger"]).factory("_koastHttp",["$http","$q","_koastLogger","_koastTokenKeeper",function(e,t,n,r){function o(){c.headers=c.headers||{},l&&(c.headers.Authorization="Bearer "+l)}function a(){return t.when()}function u(e){return a().then(function(){o()}).then(e).then(function(e){return i.isReachable=!0,e.data?e.data:e}).then(null,function(e){throw s.warn(e.data||e),e})}var s=n.makeLogger("koast.http"),i={},c={timeout:3e4},l=r.loadToken();return s.debug("Loaded token",l),i.setOptions=function(e){c=e},i.saveToken=function(e){l=e.token,r.saveToken(e)},i.deleteToken=function(){r.clear()},i.post=function(t,n,r){return r=_.cloneDeep(r)||c,r.baseUrl=c.baseUrl||"",r.method="POST",r.data=n,u(function(){var n=_.cloneDeep(r);return n.url=r.baseUrl+t,n.params=r.params,e(n)})},i.put=function(t,n,r){return r=_.cloneDeep(r)||c,r.baseUrl=c.baseUrl||"",r.method="PUT",r.data=n,u(function(){var n=_.cloneDeep(r);return n.url=r.baseUrl+t,n.params=r.params,e(n)})},i.get=function(t,n){return n=_.cloneDeep(n)||c,n.baseUrl=c.baseUrl||"",n.method="GET",u(function(){var r=_.cloneDeep(n);return r.url=n.baseUrl+t,r.params=n.params,e(r)})},i}]),angular.module("koast-http").factory("_koastTokenKeeper",["$log","$window",function(e,t){var n="KoastToken",r={};return r.setTokenKey=function(e){n=e},r.saveToken=function(e){var r=e.token||e;t.localStorage.setItem(n,r)},r.loadToken=function(){return t.localStorage.getItem(n)},r.clear=function(){return t.localStorage.removeItem(n)},r}]),angular.module("koast-logger",[]).factory("_koastLogger",[function(){function e(e,t,n){if(e=arguments[0]||{},!(e.level&&e.level<r)){var o=e.color||"black",a=[];n=Array.prototype.slice.call(n,0);var u=[];"string"==typeof n[0]&&(u.push("%c"+n.shift()),a.push("color:"+o+";")),t.groupName&&(u.unshift("%c["+t.groupName+"]"),a.unshift("color:gray;")),e.symbol&&(u.unshift("%c"+e.symbol),a.unshift("color:"+o+";font-weight:bold;font-size:150%;")),a.unshift(u.join(" ")),a=a.concat(n),Function.prototype.apply.call(console.log,console,a)}}function t(t){return t.level=n.levels[t.name],function(n,r){e(t,n,r)}}var n={};n.levels={debug:1,verbose:2,info:3,warn:4,error:5};var r=3;n.colors={},n.setLogLevel=function(e){r=e};var o={debug:t({name:"debug",color:"gray",symbol:"✍"}),verbose:t({name:"verbose",color:"cyan",symbol:"☞"}),info:t({name:"info",color:"#0074D9",symbol:"☞"}),warn:t({name:"warn",color:"orange",symbol:"⚐"}),error:t({name:"error",color:"red",symbol:"⚑"})},a=["debug","verbose","info","warn","error"];n.makeLogger=function(e){var t={};return"string"==typeof e&&(e={groupName:e}),t.options=e,a.forEach(function(e){t[e]=function(){var n=arguments;return o[e](t.options,n)}}),t};var u=n.makeLogger({});return a.forEach(function(e){n[e]=u[e]}),n}]),angular.module("koast-resource",["koast-user"]),angular.module("koast-resource").factory("_KoastEndpoint",[function(){function e(e,t,n,r){var o=this;o.prefix=e,o.handle=t,o.template=n,o.options=_.clone(r)}function t(e,t){return t?e.replace(/:([-_a-zA-Z]*)/g,function(e,n){var r=t[n],o=r||0===r;if(!o)throw new Error("Missing parameter: "+n);return t[n]}):""}return e.prototype.makePostUrl=function(){return this.prefix+this.handle},e.prototype.makeGetUrl=function(e){return this.makePostUrl()+"/"+t(this.template,e)},e}]),angular.module("koast-resource").factory("_koastResourceGetter",["_KoastResource","_KoastServerHelper","_KoastEndpoint","$http","$q","$log","_koastHttp",function(e,t,n,r,o,a,u){function s(t,n){var r=_.map(t,function(t){return new e(n.endpoint,t,n)});return n.singular&&(0===r.length?r=null:r.length>1?(a.warn("Expected a singular resource, got "+r.length),r=r[0]):r=r[0]),r}function i(e,n,r,o){var a=d[e],i={},c={},l={params:r,headers:i};if(c=angular.extend(c,a.options),c=angular.extend(c,o),c.endpoint=a,!a)throw new Error("Unknown endpoint: "+e);return t.addAuthHeaders(i),u.get(a.makeGetUrl(n),l).then(function(e){return s(e,c)})}function c(e,n,r){var a=(o.defer(),d[e]),s={};if(r=r||{},!a)throw new Error("Unknown endpoint: "+e);return t.addAuthHeaders(s),u.post(a.makePostUrl(),n,{headers:s})}var l={},f={},d={},h={};return l.setApiUriPrefix=function(e,t){t=t||"_",f[t]=e},l.getResource=function(e,t){return i(e,t,null,{singular:!0})},l.createResource=function(e,t){return c(e,t).then(null,a.error)},l.queryForResources=function(e,t){return i(e,null,t)},l.addEndpoint=function(e,t,r){r=r||{};var o=r.server||"_",a=f[o];if(!a)throw new Error("No URI prefix defined for server "+o);var u=new n(a,e,t,r);if(d[e])throw new Error("An endpoint with this handle was already defined: "+e);d[e]=u},l.init=function(e){h=e},l}]),angular.module("koast-resource").factory("_KoastResource",["_KoastServerHelper","$q","_koastHttp","$log",function(e,t,n,r){function o(e,t,n){var r,o=this;if(n.useEnvelope){if(r=t.data,!r)throw new Error("Client expects an envelope, but server did not send it properly.")}else r=t;return _.keys(r).forEach(function(e){o[e]=r[e]}),n.useEnvelope&&Object.defineProperty(this,"can",{get:function(){return t.meta.can}}),Object.defineProperty(this,"_endpoint",{get:function(){return e}}),this}return o.prototype.save=function(){var t=this._endpoint.makeGetUrl(this),r={};return e.addAuthHeaders(r),n.put(t,this,{headers:r})},o.prototype.delete=function(){r.debug("The endpoint: ",this._endpoint);var t=this._endpoint.makeGetUrl(this);r.debug("delete url:",t);var o={};return e.addAuthHeaders(o),n.delete(t,{headers:o})},o}]),angular.module("koast-resource").factory("_KoastServerHelper",["_koastUser","_koastTokenKeeper",function(e,t){var n={};return n.addAuthHeaders=function(n){e.isSignedIn&&(n["koast-auth-token"]=e.meta.token,n["koast-auth-token-timestamp"]=e.meta.timestamp,n["koast-user"]=angular.toJson(e.data)),n.Authorization="Bearer "+t.loadToken()},n}]),angular.module("koast-user",["koast-logger","koast-http"]),angular.module("koast-user").factory("_koastOauth",["$window","$location","$log","_koastLogger",function(e,t,n,r){function o(e,t){return s+"/auth/"+e+"?next="+encodeURIComponent(t)}var a="Koast_Post_Auth_Url",u={},s=t.absUrl().split("/").slice(0,3).join("/");return u.setNextUrl=function(t){e.localStorage.setItem(a,t)},u.clearNextUrl=function(){e.localStorage.removeItem(a)},u.getNextUrl=function(){return e.localStorage.getItem(a)},u.initiateAuthentication=function(n,r){u.setNextUrl(r);var a=o(n,t.absUrl());e.location.replace(a)},u.setBaseUrl=function(e){s=e},u.makeRequestURL=function(e){return e||(e=""),s+e},u}]),angular.module("koast-user").factory("_koastUser",["_koastOauth","_koastHttp","_koastLogger","$log","$timeout","$http","$window","$q","$location",function(e,t,n,r,o,a,u,s,i){function c(e){var t=v.debug.delay;return t?(r.debug("Delayng for "+t+" msec."),o(function(){return e},t)):e}function l(e){var t=e&&e.data;return g.debug("Setting the user based on",e),t?(e.isAuthenticated&&(g.info("response body is",e),g.info("response body data is",e.data),g.info("response body meta is",e.meta),v.data=e.data,v.meta=e.meta,v.meta.token&&m.saveToken({token:v.meta.token,expires:v.meta.expires}),b.resolve()),v.isAuthenticated=e.isAuthenticated):(g.warn("Did not get back a valid user record.",e),v.data={},v.isAuthenticated=!1,v.meta={}),v.isReady=!0,v.isAuthenticated}function f(e){return e&&!v.meta.isRegistered&&p?o(p,0).then(function(){return e}):e}function d(){var t=e.getNextUrl();return e.clearNextUrl(),t?void i.url(t):{}}function h(e){return m.get(e||"/auth/user").then(null,function(e){if(401===e.status)return null;throw e}).then(c).then(l).then(f)}var p,k,g=n.makeLogger("koast.user"),m=t,v={isAuthenticated:!1,isReady:!1,data:{},meta:{}},b=s.defer();return v.getUserData=h,v.saveToken=function(e,t){m.saveToken({token:e,expires:t})},v.initiateOauthAuthentication=function(t,n){e.initiateAuthentication(t,n)},v.logout=function(t){return m.deleteToken(),a.post(e.makeRequestURL("/auth/logout")).then(function(e){if("Ok"!==e.data)throw new Error("Failed to logout.");u.location.replace(t||"/")}).then(null,function(e){throw r.error(e),e})},v.loginLocal=function(t){r.debug("Login:",t.username);var n={username:t.username,password:t.password};return a.post(e.makeRequestURL("/auth/login"),n).then(function(e){return g.debug("loginLocal:",e),e.data}).then(l)},v.registerSocial=function(e){return m.put("/auth/user",e).then(function(e){return e.meta.token&&v.saveToken(e.meta.token,e.meta.expires),h()})},v.registerLocal=function(t){return a.post(e.makeRequestURL("/auth/user"),t)},v.checkUsernameAvailability=function(e){var t="/auth/usernameAvailable";return m.get(t,{params:{username:e}}).then(function(e){return e.data===!0}).then(null,function(){})},v.resetPassword=function(t){return a.post(e.makeRequestURL("/forgot"),{email:t})},v.setNewPassword=function(t,n){return a.post(e.makeRequestURL("/reset/"+n),{password:t})},v.setRegistrationHanler=function(e){p=e},v.getStatusPromise=function(){return k||(k=h()),k},v.whenStatusIsKnown=v.getStatusPromise,v.refreshToken=function(e,t){return m.get(e||"/auth/token/refresh").then(function(e){return e.token?(v.meta.token=e.token,e):t})},v.checkForToken=function(){var e=i.search().redirectToken;return e?(v.saveToken(e),v.refreshToken(null,e).then(function(e){return v.saveToken(e.token,e.expires)})):s.when({})},v.init=function(t){return t.debug=t.debug||{},v.debug=t.debug,e.setBaseUrl(t.baseUrl),v.checkForToken().then(v.getStatusPromise).then(d)},v.whenAuthenticated=function(){return b.promise},v}]),angular.module("koast-versionCheck",["koast-http","koast-logger"]).factory("versionCheck",["_koastHttp","peerDependencies","$log",function(e,t,n){function r(e){var t=e.isCompatible?n.info:n.error;return t(e.isCompatible?"Current version of kaost-angular is compatible with server":"Current version of kaost-angular is not compatible with server"),t("isCompatible",e.isCompatible),t("koast server version:",e.koastVersion),t("koast-angular compatible versions:",e.checkedVersion),e}function o(n){return n=n||t.koast,n=encodeURIComponent(n),e.get(a+n).then(r)}var a="/meta/koast-angular/check-compatability?koast-version=";return{isCompatible:o}}])}(window,document);